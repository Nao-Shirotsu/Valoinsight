const advancedKpiData = [
  {
    heading: 'Á∑®Êàê‰∏≠',
    items: [
      { id: 'remember-vc', text: 'Ë™∞„ÅÆVC„ÅåÁÑ°„ÅÑ„ÅãË¶ö„Åà„Å¶„Åæ„Åó„Åü„Åã', attributes: ['teamplay', 'thinking'] },
      { id: 'role-balance', text: '„É≠„Éº„É´ÈÅé‰∏çË∂≥„ÅØË™çË≠ò„Åß„Åç„Åæ„Åó„Åü„Åã', note: ['„Ç®„É≥„Éà„É™„Éº/Á¥¢Êïµ/„Çπ„É¢„Éº„ÇØ/„Éà„É©„ÉÉ„Éó/„Éï„É©„ÉÉ„Ç∑„É•'], attributes: ['teamplay', 'study'] },
      { id: 'strategy-axis', text: 'Á∑®Êàê„Åã„ÇâÁ´ã„Å°Âõû„Çä„ÅÆËª∏„ÇíË¶ã„ÅÑ„Å†„Åõ„Åæ„Åó„Åü„Åã', attributes: ['teamplay', 'thinking', 'study'] }
    ]
  },
  {
    heading: '1stÊ∫ñÂÇô„Éï„Çß„Éº„Ç∫',
    items: [
      { id: 'self-role', text: 'Ëá™ÂàÜ„Åå„É≠„Éº„É´„ÇíÂÖ®„ÅÜ„Åô„Åπ„Åç„Åã/„Ç§„É¨„ÇÆ„É•„É©„ÉºÂØæÂøú„Åô„Åπ„Åç„ÅãÂà§Êñ≠„Åß„Åç„Åæ„Åó„Åü„Åã', note: ['„Éª0„Éá„É•„Ç®2„Ç§„Éã„Ç∑Á∑®Êàê„ÅßËá™ÂàÜ„Ç§„Éã„Ç∑ ‚Üí Ëá™ÂàÜ„Åå„Éá„É•„Ç®ÁöÑ„Å™Êà¶„ÅÜÂãï„Åç„Çí„Åô„Çã', '„ÉªÊîª„ÇÅ„Åß„Çµ„Ç§„Éï„Ç°„Éº„ÅåÈÄÜ„Çµ„Ç§„ÉàÁÆ°ÁêÜ„Åó„Å¶„Åè„Çå„Åù„ÅÜ ‚Üí „Éá„Éï„Ç©„É´„ÉàÊà¶Ë°ì', '„Éª„Ç§„Éã„Ç∑„Åå„Éá„É•„Ç®„Å´„Åè„Å£„Å§„ÅÑ„Å¶„Ç¢„Éì„É™„ÉÜ„Ç£Êäï„Åí„Åù„ÅÜ ‚Üí „É©„ÉÉ„Ç∑„É•ÂèØËÉΩ„Åã„ÇÇ'], attributes: ['thinking', 'study'] },
      { id: 'ally-counter', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´: ÊïµÁ∑®Êàê„Å´ÂØæ„Åô„Çã„Ç¢„É≥„ÉÅÊà¶Ë°ìËÄÉÊ°à„Å®Âë≥Êñπ„Å∏„ÅÆÂ£∞Êéõ„Åë„ÅØ„Åß„Åç„Åæ„Åó„Åü„Åã', note: ['„ÉªÂë≥Êñπ„ÅåÊïµ„ÅÆÁ∑®Êàê„Åã„ÇâÂØæÁ≠ñ„ÇíËÄÉ„Åà„Çâ„Çå„Åù„ÅÜ„ÅãÂà§Êñ≠„Åô„Çã', '„Éª„Éç„Ç™„É≥„Åå„ÉØ„Ç§„É§„Éº„ÅÆ„ÅÇ„ÇãÊâÄ„Å´Ë°å„Åã„Å™„Åù„ÅÜ„Åã„ÄÅË°å„Åè„Å®„Åó„Å¶„ÇÇ„Ç¢„É≥„ÉÅ„ÉØ„Ç§„É§„Éº„ÇíËÄÉ„Åà„Å¶„ÅÑ„Åù„ÅÜ„Åã„ÄÅ„Å™„Å©'], attributes: ['thinking', 'study', 'teamplay'] },
      { id: 'weird-teammate', text: 'Âë≥Êñπ„Å´Â§â„Å™Â•¥„Åå„ÅÑ„ÇãÂ†¥Âêà: „Åù„ÅÆ‰∫∫„Å®„ÅÆÈÄ£Êê∫„Éó„É¨„Ç§„ÅÆÂÑ™ÂÖàÂ∫¶„Çí‰∏ã„Åí„ÇãÊ±∫ÊÑè„Çí„Åó„Åæ„Åó„Åü„Åã', note: ['„ÉªÂêçÂâç„Åå„ÄåSDGs„Äç„Äå‚óØ‚óØ„Éà„É≠„Éº„É´„Åó„Åæ„Åô„Äç', '„ÉªVC„ÅßÊòé„Çâ„Åã„Å´ÊßòÂ≠ê„Åå„Åä„Åã„Åó„ÅÑ'], attributes: ['thinking', 'alert'] }
    ]
  },
  {
    heading: 'ÂêÑ„É©„Ç¶„É≥„Éâ„ÅÆÊ∫ñÂÇô„Éï„Çß„Éº„Ç∫',
    items: [
      { id: 'weapon-econ', text: 'ÊïµÂë≥Êñπ„ÅÆÊ≠¶Âô®ÁÆ°ÁêÜ„ÇíÈÅ©Âàá„Å´Ë°å„Åà„Åæ„Åó„Åü„Åã', note: ['„ÉªÂë≥Êñπ„Åå„Éè„Éº„Éï„Åß4‰∫∫Ë≤∑„Åà„ÇãÊôÇ„Å´Âëº„Å≥„Åã„Åë', '„ÉªÊïµ„Åå„Ç®„Ç≥„Åã„Å©„ÅÜ„Åã', '„ÉªÊïµ„Å´„Ç™„Éö„É¨„Éº„Çø„Éº„ÅåÂá∫„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„Åã'], attributes: ['thinking', 'study'] },
      { id: 'ult-management', text: 'ÊïµÂë≥Êñπ„ÅÆ„Ç¢„É´„ÉÜ„Ç£„É°„ÉÉ„ÉàÁÆ°ÁêÜ„ÇíÈÅ©Âàá„Å´Ë°å„Åà„Åæ„Åó„Åü„Åã', note: ['„ÉªÂ∫ÉÁØÑÂõ≤„Éá„Éê„ÉïÁ≥ª„Ç¶„É´„Éà(KJ, „Éñ„É™„Éº„ÉÅ „Å™„Å©)„Å´„Çà„Å£„Å¶„Å©„ÅÜ‰ªïÊéõ„Åë„Çã„Åã„Éª‰ªïÊéõ„Åë„Çâ„Çå„Çã„Åã'], attributes: ['thinking', 'study'] },
      { id: 'emotion-reset', text: 'Ââç„É©„Ç¶„É≥„Éâ„ÅÆÊÑüÊÉÖÂá¶ÁêÜ„Çí5Áßí‰ª•ÂÜÖ„Å´ÁµÇ„Çè„Çâ„Åõ„Åæ„Åó„Åü„Åã', note: ['„ÉªÊÆã20Áßí„Åæ„Åß„Å´Ê¨°„ÅÆË©±„ÇíÂßã„ÇÅ„Çâ„Çå„Å™„ÅÑ„Å®Âë≥Êñπ„Å´Êµ∏ÈÄè„Åó„Å™„ÅÑ'], attributes: ['thinking'] },
      { id: 'counter-plan', text: 'Ââç„ÅÆ„É©„Ç¶„É≥„Éâ„ÅÆÂÜÖÂÆπ„Çí„ÇÇ„Å®„Å´ÈÅ©Âàá„Å´ÂØæÁ≠ñ„ÇíËÄÉ„Åà„Çâ„Çå„Åæ„Åó„Åü„Åã', attributes: ['thinking', 'study'] },
      { id: 'propose-strat', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶‰ΩúÊà¶„ÇíÊèêÊ°à„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['thinking', 'teamplay'] }
    ]
  },
  {
    heading: '„É©„Ç¶„É≥„Éâ‰∏≠',
    subsections: [
      {
        heading: 'ÊíÉ„Å°Âêà„ÅÑ',
        items: [
          { id: 'headline', text: '„Éò„ÉÉ„Éâ„É©„Ç§„É≥„ÇíÁ∂≠ÊåÅ„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['physical'] },
          { id: 'angle-advantage', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´„Ç¢„É≥„Ç∞„É´(ÈÅ†ËøëÂ£Å)ÊúâÂà©„ÇíÂèñ„Çå„Å¶„ÅÑ„Åæ„Åó„Åü„Åã', attributes: ['physical'] },
          { id: 'off-angle', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´„Ç™„Éï„Ç¢„É≥„Ç∞„É´„Çí‰Ωø„Åà„Åæ„Åó„Åü„Åã', attributes: ['physical', 'judgement'] },
          { id: 'peeker-adv', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´„Éî„Éº„Ç´„Éº„Ç∫„Ç¢„Éâ„Éê„É≥„ÉÜ„Éº„Ç∏„ÇíÂèñ„Çå„Å¶„ÅÑ„Åæ„Åó„Åü„Åã', attributes: ['physical'] },
          { id: 'timing-peek', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´„Çø„Ç§„Éü„É≥„Ç∞„Éî„Éº„ÇØ„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['physical'] },
          { id: 'slicing-pie', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´„Ç´„ÉÉ„ÉÜ„Ç£„É≥„Ç∞„Éë„Ç§„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['physical'] },
          { id: 'cover-angle', text: 'Âë≥Êñπ„Åå„Ç´„Éê„ÉºÂ∞ÑÁ∑ö„ÇíÈÄö„Åõ„Çã„Ç¢„É≥„Ç∞„É´&‰ΩçÁΩÆ„ÅÆÁ∂≠ÊåÅ„ÅØ„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['physical', 'judgement', 'teamplay'] },
          { id: 'magazine', text: '„Éû„Ç¨„Ç∏„É≥ÊÆãÂºæÊï∞ÁÆ°ÁêÜ„ÅØÈÅ©Âàá„Åß„Åó„Åü„Åã', attributes: ['physical'] },
          { id: 'anti-wallbang', text: '„É¢„ÇØÊäú„Åç„Åï„Çå„Å´„Åè„ÅÑ‰ΩçÁΩÆ„Å´„ÅÑ„Åæ„Åó„Åü„Åã', attributes: ['judgement'] },
          { id: 'anti-flash', text: '„Éï„É©„ÉÉ„Ç∑„É•„ÇíÈ£ü„Çâ„Å£„Å¶„ÇÇÁîüÂ≠ò„Åß„Åç„Çã‰ΩçÁΩÆ„Å´„ÅÑ„Åæ„Åó„Åü„Åã', attributes: ['judgement'] },
          { id: 'variable-peak', text: '‰Ωì„ÅÆÂá∫„ÅóÊñπ„Å´Á∑©ÊÄ•„Çí„Å§„Åë„Çâ„Çå„Åæ„Åó„Åü„Åã', attributes: ['physical'] },
          { id: 'safe-melee', text: 'ËøëÊé•Ê≠¶Âô®„Éª„Ç¢„Éì„É™„ÉÜ„Ç£„ÅØÂÆâÂÖ®„Å™Áä∂Ê≥Å„Åß„ÅÆ„ÅøÊßã„Åà„Å¶„ÅÑ„Åæ„Åó„Åü„Åã', attributes: ['judgement'] }
        ]
      },
      {
        heading: 'Áõ§Èù¢ÁÆ°ÁêÜ',
        items: [
          { id: 'engage-decision', text: 'Êé•Êïµ„Åó„Å¶„ÅÑ„ÅÑ„ÅãÂà§Êñ≠„Åó„Å¶„Åã„Çâ„Éî„Éº„ÇØ„Åó„Åæ„Åó„Åü„Åã', attributes: ['judgement', 'alert'] },
          { id: 'reposition', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´„Éù„Ç∏„Ç∑„Éß„É≥„ÇíÂ§â„Åà„Åæ„Åó„Åü„Åã', attributes: ['judgement', 'alert'] },
          { id: 'consider-enemy-count', text: '„Ç®„É≥„Éà„É™„Éº„ÅÆÂâç„Å´Êïµ„ÅÆÊï∞„Å®Ë≥™„ÅÆ‰∏°Êñπ„ÇíËÄÉÊÖÆ„Åó„Åæ„Åó„Åü„Åã', attributes: ['judgement', 'thinking', 'study'] },
          { id: 'not-miss-rotate', text: '„É≠„Éº„ÉÜ„Éº„Éà„ÅåÂá∫Êù•„ÇãÁä∂Ê≥Å„ÇíË¶ãËêΩ„Å®„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü„Åã', attributes: ['judgement', 'thinking'] },
          { id: 'rotate-reason', text: '„É≠„Éº„ÉÜ„Éº„Éà„Åô„ÇãÂà§Êñ≠„ÅÆÈöõ„ÄÅÈÅ©Âàá„Å™Ê†πÊã†„ÅØ„ÅÇ„Çä„Åæ„Åó„Åü„Åã', attributes: ['judgement', 'thinking', 'study'] },
          { id: 'ult-change', text: 'ÊïµÂë≥Êñπ„ÅÆ„Ç¢„É´„ÉÜ„Ç£„É°„ÉÉ„ÉàÁä∂Ê≥ÅÂ§âÂåñ„ÇíË™çË≠ò„Åó„Å¶„ÅÑ„Åæ„Åó„Åü„Åã', attributes: ['judgement', 'alert'] },
          { id: 'silent-steps', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´Ë∂≥Èü≥„ÇíÊ∂à„Åõ„Åæ„Åó„Åü„Åã', note: ['„Éª„É©„Ç¶„É≥„ÉâÈñãÂßãÁõ¥Âæå„ÅÆÊÉÖÂ†±Âèñ„ÇäÊÆµÈöé', '„Éª„É≠„Éº„ÉÜ„Éº„ÉàÁîªÁ≠ñ‰∏≠'], attributes: ['judgement', 'alert', 'thinking'] },
          { id: 'push-care', text: '„Éó„ÉÉ„Ç∑„É•„Ç±„Ç¢„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['judgement','alert'] },
          { id: 'scoreboard-check', text: 'ÂèØËÉΩ„Å™ÊôÇ„ÄÅ„Ç™„Éº„Éñ„Å®„Éó„É©„É≥„Éà„ÅÆÈü≥„Åß„Çπ„Ç≥„Ç¢„Éú„Éº„Éâ„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['judgement', 'thinking'] },
          { id: 'backstab-care', text: 'Ë£èÂèñ„Çä„Åï„Çå„ÅÜ„Çã„Ç®„É™„Ç¢„ÅßÈÅ©Âàá„Å´Ë≠¶Êàí„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['judgement', 'alert'] },
          { id: 'clearing', text: '‰∏ÅÂØß„Å´„ÇØ„É™„Ç¢„É™„É≥„Ç∞„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['alert'] }
        ]
      },
      {
        heading: '„ÉÅ„Éº„É†„Éó„É¨„Ç§',
        items: [
          { id: 'death-call', text: 'Ê≠ª‰∫°ÊôÇ„Å´Âç≥Â∫ß„Å´ÂøÖË¶Å„Å™„Åì„Å®„ÇíÂ†±Âëä„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['teamplay', 'judgement'] },
          { id: 'ask-help', text: 'Ëá™ÂàÜ„ÅåÂõ∞„Å£„ÅüÊôÇ„Å´ÈÅ©Âàá„Å´Âä©„Åë„ÇíË¶ÅÊ±Ç„Åó„Åæ„Åó„Åü„Åã', attributes: ['teamplay', 'judgement'] },
          { id: 'follow-entry', text: 'ÈÅ©Âàá„Å´„Ç®„É≥„Éà„É™„Éº„Å´ÁùÄ„ÅÑ„Å¶„ÅÑ„Åç„Åæ„Åó„Åü„Åã', attributes: ['teamplay', 'judgement'] },
          { id: 'support-duelist', text: '„Éá„É•„Ç®„É™„Çπ„Éà(ÂÖàÈ†≠„ÅÆ‰∫∫)„ÅåÂõ∞„Å£„Å¶„ÅÑ„ÇãÊôÇ„Å´ÈÅ©Âàá„Å´ÊèêÊ°à„Åó„Åü„Çä„ÄÅÈÅ©Âàá„Å´ÊîØÊè¥„Ç¢„Éì„É™„ÉÜ„Ç£„ÇíÂá∫„Åõ„Åæ„Åó„Åü„Åã', attributes: ['teamplay', 'thinking'] },
          { id: 'cover-line', text: 'ÂøÖË¶Å„Å´Âøú„Åò„Å¶ÈÅ©Âàá„Å´Âë≥Êñπ„Å∏„ÅÆ„Ç´„Éê„Éº„ÅÆÂ∞ÑÁ∑ö„ÇíÈÄö„Åõ„Åæ„Åó„Åü„Åã', attributes: ['teamplay', 'physical'] },
          { id: 'protect-defuser', text: 'Ëß£Èô§ËÄÖ„ÅÆÂ∞ÑÁ∑ö„Å´Êïµ„ÅåÁ´ã„Åü„Å™„ÅÑ„Çà„ÅÜ„Å´„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['teamplay', 'judgement'] }
        ]
      },
      {
        heading: '„Éó„É©„É≥„Éà„Éª„Éù„Çπ„Éà„Éó„É©„É≥„Éà',
        items: [
          { id: 'plant-delay', text: '„Å©„Åì„ÅßÈÅÖÂª∂Ë°åÁÇ∫„Åå„Åó„ÇÑ„Åô„ÅÑ„ÅãËÄÉ„Åà„Å¶„Éó„É©„É≥„Éà‰ΩçÁΩÆ„ÇíÊ±∫„ÇÅ„Åæ„Åó„Åü„Åã', attributes: ['study', 'judgement', 'thinking'] },
          { id: 'postplant-position', text: 'Ë¶ãÊñπ„ÅåË®≠ÁΩÆ„Åó„Åü‰ΩçÁΩÆ„Å´ÂØæ„Åó„Å¶Âº∑„ÅÑ‰ΩçÁΩÆÂèñ„Çä„Åå„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['study', 'judgement'] },
          { id: 'ability-awareness', text: 'Âë≥Êñπ„Å®Êïµ„ÅÆÊÆã„Ç¢„Éì„É™„ÉÜ„Ç£„ÇíË™çË≠ò„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['study', 'judgement', 'teamplay'] },
          { id: 'ally-reaction', text: 'Âë≥Êñπ„ÅÆÂãï„Åç„ÇíË¶ã„Å¶„Åù„Çå„Å´ÂØæÂøú„Åó„ÅüÈÅ©Âàá„Å™„Éù„Ç∏„Ç∑„Éß„Éã„É≥„Ç∞„ÅØ„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['study', 'judgement', 'thinking', 'teamplay'] }
        ]
      }
    ]
  },
  {
        heading: 'Â∫ßÂ≠¶',
        items: [         
          { id: 'weapon-knowledge', text: 'ÂÖ®„Å¶„ÅÆÊ≠¶Âô®„ÅÆ„ÉÄ„É°„Éº„Ç∏„Å®ÁâπÂæ¥„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'buy-amount-memory', text: '„Éï„É´„Éê„Ç§„Å®„Éè„Éº„Éï„Ç¢„Éº„Éû„Éº„Éê„Ç§„ÅÆÈáëÈ°ç„ÇíË¶ö„Åà„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'ability-cost-awareness', text: 'Ëá™ÂàÜ„ÅÆ„Ç¢„Éì„É™„ÉÜ„Ç£„ÅÆÂêàË®àÈáëÈ°ç„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'spike-benefits', text: '„Çπ„Éë„Ç§„ÇØ„ÇíË®≠ÁΩÆ„ÉªËß£Èô§„Åó„ÅüÈöõ„Å´Âæó„Çâ„Çå„Çã„É°„É™„ÉÉ„Éà„ÇíÂÖ®„Å¶Áü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'spike-timers', text: '„Çπ„Éë„Ç§„ÇØ„ÅÆË®≠ÁΩÆ„ÉªÁàÜÁô∫„ÉªËß£Èô§„Å´„Åã„Åã„ÇãÁßíÊï∞„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'spike-cues', text: 'Ë®≠ÁΩÆÂæå„ÅÆ„Çπ„Éë„Ç§„ÇØ„ÅÆË¶ã„ÅüÁõÆ„ÇÑÈü≥„ÅÆÂ§âÂåñ„ÅßÂàÜ„Åã„ÇãÊÉÖÂ†±„ÇíÂÖ®„Å¶Áü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'map-official-calls', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„ÅÆ„ÄÅÂÖ¨Âºè„Å™„Ç®„É™„Ç¢„ÅÆÂêçÁß∞„ÇíÂÖ®„Å¶Áü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', note: ['„Éª„É©„Éï„Çø„Éº, „Çø„Éî„Ç™„Ç´„Å™„Å©'], attributes: ['study'] },
          { id: 'map-nickname-calls', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„ÅÆ„ÄÅÈùûÂÖ¨Âºè„Å™„Ç®„É™„Ç¢„ÅÆ‰øóÁß∞„ÇíÊ¶Ç„Å≠Áü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', note: ['„Éª„Éò„É¥„É≥, „Ç∂„É™„Ç¨„Éã„Å™„Å©'], attributes: ['study'] },
          { id: 'sniper-spots', text: '„Çπ„Éä„Ç§„Éë„Éº„Åå„Çà„ÅèÂá∫„Å¶„Åè„ÇãÂ†¥ÊâÄ„Å®„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'shotgun-spots', text: '„Ç∑„Éß„ÉÉ„Éà„Ç¨„É≥„Åå„Çà„ÅèÂá∫„Å¶„Åè„ÇãÂ†¥ÊâÄ„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'map-key-areas', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„Åß‰∏ÄËà¨ÁöÑ„Å´ÈáçË¶Å„Å®„Åï„Çå„Çã„Ç®„É™„Ç¢„ÅØ„Å©„Åì„Åã„ÄÅÁêÜÁî±„ÇÇÂê´„ÇÅ„Å¶Ë™¨Êòé„Åß„Åç„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'map-essential-agents', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„Åß‰∏ÄËà¨ÁöÑ„Å´ÂøÖÈ†à„Å®„Åï„Çå„Çã„Ç®„Éº„Ç∏„Çß„É≥„Éà„Çí„ÄÅÁêÜÁî±„ÇÇÂê´„ÇÅ„Å¶Ë™¨Êòé„Åß„Åç„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'map-plant-spots', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„ÅÆ„ÄÅ‰∏ÄËà¨ÁöÑ„Å™„Éó„É©„É≥„Éà‰ΩçÁΩÆ„ÇíÂÖ®„Å¶Áü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'map-chokepoints', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„Å´„Åä„Åë„Çã„ÄÅ‰∏ÄËà¨ÁöÑ„Å™„ÉÅ„Éß„Éº„ÇØ„Éù„Ç§„É≥„Éà„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', note: ['„Éª„ÉÅ„Éß„Éº„ÇØ„Éù„Ç§„É≥„Éà„Å®„ÅØÔºöÊïµ„ÅåÂá∫„Å¶„Åè„ÇãÊâÄ'] , attributes: ['study'] },
          { id: 'map-off-angles', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„Å´„Åä„Åë„Çã„ÄÅ‰∏ÄËà¨ÁöÑ„Å™„Ç™„Éï„Ç¢„É≥„Ç∞„É´„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'map-highground', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„Å´„Åä„Åë„Çã„ÄÅ‰∏ÄËà¨ÁöÑ„Å™È´òÊâÄ„Éù„Ç∏„Ç∑„Éß„É≥„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', note: ['„Éª„Ç∏„Çß„ÉÉ„Éà„ÇÑ„Ç™„Éº„É°„É≥„Å™„Å©„ÄÅÁßªÂãï„Ç¢„Éì„É™„ÉÜ„Ç£‰ΩøÁî®ÂæåÈôêÂÆö„ÅÆ„Éù„Ç∏„Ç∑„Éß„É≥„ÇíÂê´„ÇÄ'] , attributes: ['study'] },
          { id: 'signature-knowledge', text: '‰ªäÂõû„ÅÆË©¶Âêà„Åß‰Ωø„Çè„Çå„ÅüÂÖ®„Å¶„ÅÆ„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆ„Ç∑„Ç∞„Éç„ÉÅ„É£„Éº„Ç¢„Éì„É™„ÉÜ„Ç£„Å®„ÄÅ„Åù„ÅÆ„É™„Ç≠„É£„Çπ„Éà„Çø„Ç§„É†„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'flash-stun-knowledge', text: '‰ªäÂõû„ÅÆË©¶Âêà„Åß‰Ωø„Çè„Çå„Åü„Ç®„Éº„Ç∏„Çß„É≥„Éà„ÅÆ„ÄÅÂÖ®„Å¶„ÅÆ„Éï„É©„ÉÉ„Ç∑„É•„Éª„Çπ„Çø„É≥„ÅÆÂäπÊûú„Å®ÁØÑÂõ≤„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'flash-stun-spots', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„Åß„ÄÅ‰∏ÄËà¨ÁöÑ„Å´„Éï„É©„ÉÉ„Ç∑„É•„ÇÑ„Çπ„Çø„É≥„ÅåËâØ„Åè‰Ωø„Çè„Çå„ÇãÂ†¥ÊâÄ„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'sentinel-trap-knowledge', text: '‰ªäÂõû„ÅÆË©¶Âêà„Åß‰Ωø„Çè„Çå„ÅüÂÖ®„Å¶„ÅÆ„Çª„É≥„ÉÅ„Éç„É´„ÅÆÊåÅ„Å§„ÄÅ„Éà„É©„ÉÉ„Éó„ÅÆ‰∏ÄËà¨ÁöÑ„Å™ÂÆöÁÇπ„Å®ÂØæÁ≠ñ„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'smoke-usage-knowledge', text: '‰∏ÄËà¨ÁöÑ„Å™„Çπ„É¢„Éº„ÇØ„ÅÆÁΩÆ„ÅçÊñπ„Å®„ÄÅ„Åù„ÅÆ‰Ωø„ÅÑÊñπ„ÇíÂÖ®„Å¶Áü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', note: ['„ÉªÈñâ„Åò„ÉªËÄê„Åà„Éª„ÇÇ„Å£„Åì„Çä„Éª1way „Å™„Å©'], attributes: ['study'] },
          { id: 'recon-usage-knowledge', text: 'Á¥¢Êïµ„Ç¢„Éì„É™„ÉÜ„Ç£„Åå‰∏ÄËà¨ÁöÑ„Å´„Å©„Åì„Å´Êäï„Åí„Çâ„Çå„ÄÅ„Åù„Çå„Åå„Å©„ÅÆ„Ç®„É™„Ç¢„ÇíÊò†„ÅôÁÇ∫„ÅÆ„ÇÇ„ÅÆ„ÅãÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'drone-required-areas', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„Åß„ÄÅ„Éâ„É≠„Éº„É≥Á≥ª„ÅÆÁ¥¢Êïµ„ÅåÁÑ°„Åë„Çå„Å∞Ê•µ„ÇÅ„Å¶ÈÄ≤„Åø„Å•„Çâ„ÅÑ„Ç®„É™„Ç¢„Åå„Å©„Åì„Åã„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'molly-count-knowledge', text: '‰ªäÂõû„ÅÆË©¶Âêà„Åß‰∫í„ÅÑ„ÅÆ„ÉÅ„Éº„É†„Å´„É¢„É≠„Éà„Éï„ÅåÂêàË®à‰ΩïÂÄã„ÅÇ„Çä„ÄÅ„Åù„Çå„Åû„Çå‰ΩïÁßí„ÅÇ„Çã„ÅãÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] },
          { id: 'utility-ult-counterplay', text: 'Êïµ„ÅÆ„Ç§„Éã„Ç∑„Ç®„Éº„Çø„Éº„Å®„Ç≠„É´„Ç∏„Éß„Ç§„Å®„ÇØ„É≠„Éº„É¥„ÅÆ„Ç¶„É´„Éà„ÅÆÊÄßËÉΩ„Å®ÂØæÁ≠ñ„ÇíÁü•„Å£„Å¶„ÅÑ„Åæ„Åô„Åã', attributes: ['study'] }
        ]
      }
];

const simpleKpiData = [
  {
    
    items: [
      { id: 'xx1', text: '„Ç®„Ç§„É†/„Éî„Éº„ÇØ„ÅÆ‰ªïÊñπ„ÅØËâØ„Åã„Å£„Åü„Åß„Åô„Åã', attributes: ['physical'] },
      { id: 'xx2', text: 'ÈÅÆËîΩÁâ©„ÇíÊ¥ª„Åã„Åõ„Åæ„Åó„Åü„Åã', attributes: ['physical'] },
      { id: 'xx3', text: 'Âë≥Êñπ„Å´‰ªò„ÅÑ„Å¶„ÅÑ„Åç„Åæ„Åó„Åü„Åã/Âë≥Êñπ„Åå‰ªò„ÅÑ„Å¶„Åì„Çå„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åã„ÇâË°å„Åç„Åæ„Åó„Åü„Åã', attributes: ['teamplay'] },
      { id: 'xx4', text: 'Âë≥Êñπ„ÅÆ„Åü„ÇÅ„Å´„Ç¢„Éì„É™„ÉÜ„Ç£„Çí‰Ωø„Åà„Åæ„Åó„Åü„Åã', attributes: ['teamplay'] },
      { id: 'xx5', text: 'ÂÆâÂÖ®„Å™ÊôÇ„ÅØ„Éü„Éã„Éû„ÉÉ„Éó„ÇíË¶ã„Å¶„ÅÑ„Åæ„Åó„Åü„Åã', attributes: ['judgement'] },
      { id: 'xx6', text: '„Ç®„É≥„Éà„É™„ÉºÂâç„Å´Êïµ„ÅåÂ§ö„Åè„Å™„ÅÑ„ÅãÂà§Êñ≠„Åó„Åæ„Åó„Åü„Åã', attributes: ['judgement'] },
      { id: 'xx7', text: '‰∏ÅÂØß„Å´„ÇØ„É™„Ç¢„É™„É≥„Ç∞„Åß„Åç„Åæ„Åó„Åü„Åã', attributes: ['alert'] },
      { id: 'xx8', text: '„Éï„É©„ÉÉ„Ç∑„É•/„É¢„ÇØÊäú„Åç„Åß„ÇÑ„Çâ„Çå„Å´„Åè„ÅÑ‰ΩçÁΩÆ„Å´„ÅÑ„Åæ„Åó„Åü„Åã', attributes: ['alert'] },
      { id: 'xx9', text: 'ÊïµÂë≥Êñπ„ÅÆ„Ç¢„É´„ÉÜ„Ç£„É°„ÉÉ„ÉàÁä∂Ê≥Å„ÇíË¶ã„Å¶„Åã„ÇâÂãï„ÅçÂá∫„Åõ„Åæ„Åó„Åü„Åã', attributes: ['thinking'] },
      { id: 'x10', text: 'Ââç„É©„Ç¶„É≥„Éâ„ÅÆÊïµ„ÅÆÂãï„Åç„ÅÆÂØæÁ≠ñ„ÇíËÄÉ„Åà„Å¶„Åã„ÇâÂãï„ÅçÂá∫„Åõ„Åæ„Åó„Åü„Åã', attributes: ['thinking'] },
      { id: 'x11', text: '‰ªäÂõû„ÅÆ„Éû„ÉÉ„Éó„ÅÆÈáçË¶Å„Å™„Ç®„É™„Ç¢„ÅØ„Å©„Åì„ÅãË™¨Êòé„Åß„Åç„Åæ„Åô„Åã', attributes: ['study'] },
      { id: 'x12', text: 'ÊïµÂë≥ÊñπÂÖ®Âì°„ÅÆ„Ç¢„Éì„É™„ÉÜ„Ç£„Å®‰Ωø„ÅÑÊñπ„ÇíË™¨Êòé„Åß„Åç„Åæ„Åô„Åã', attributes: ['study'] }
    ]
  }
];
// Build KPI sections including headings while collecting items
const kpiItems = [];
const container = document.getElementById('kpi-container');
const selectionContainer = document.getElementById('selection-container');
const dropArea = document.getElementById('json-drop-area');
const complexityToggle = document.getElementById('complexity-toggle');
let selectedMap = null;
let selectedAgent = null;
let loadedDatasets = [];

function buildSelectionRow(options, className, onSelect) {
  const row = document.createElement('div');
  row.classList.add('selection-row');
  options.forEach(opt => {
    const btn = document.createElement('div');
    btn.classList.add('selection-button', className);
    const img = document.createElement('img');
    img.src = opt.src;
    const value = opt.src.split('/').pop().replace('.webp', '');
    img.alt = value;
    btn.appendChild(img);
    if (opt.label) {
      const label = document.createElement('div');
      label.classList.add('map-label');
      label.textContent = opt.label;
      btn.appendChild(label);
    }
    btn.addEventListener('click', () => {
      const isSelected = btn.classList.contains('selected');
      Array.from(row.children).forEach(child => child.classList.remove('selected'));
      if (isSelected) {
        onSelect(null);
      } else {
        btn.classList.add('selected');
        onSelect(value);
      }
    });
    row.appendChild(btn);
  });
  selectionContainer.appendChild(row);
}

if (selectionContainer) {
  const mapOptions = [
    { src: 'assets/maps/abyss.webp', label: '„Ç¢„Éì„Çπ' },
    { src: 'assets/maps/ascent.webp', label: '„Ç¢„Çª„É≥„Éà' },
    { src: 'assets/maps/bind.webp', label: '„Éê„Ç§„É≥„Éâ' },
    { src: 'assets/maps/breeze.webp', label: '„Éñ„É™„Éº„Ç∫' },
    { src: 'assets/maps/corrode.webp', label: '„Ç´„É≠„Éº„Éâ' },
    { src: 'assets/maps/fracture.webp', label: '„Éï„É©„ÇØ„ÉÅ„É£„Éº' },
    { src: 'assets/maps/haven.webp', label: '„Éò„Ç§„É¥„É≥' },
    { src: 'assets/maps/icebox.webp', label: '„Ç¢„Ç§„Çπ„Éú„ÉÉ„ÇØ„Çπ' },
    { src: 'assets/maps/lotus.webp', label: '„É≠„Éº„Çø„Çπ' },
    { src: 'assets/maps/pearl.webp', label: '„Éë„Éº„É´' },
    { src: 'assets/maps/split.webp', label: '„Çπ„Éó„É™„ÉÉ„Éà' },
    { src: 'assets/maps/sunset.webp', label: '„Çµ„É≥„Çª„ÉÉ„Éà' }
  ];
  buildSelectionRow(mapOptions, 'map-button', value => {
    selectedMap = value;
    if (modeToggle.checked) {
      refreshStats();
    }
  });

  const agentOptions = [
    { src: 'assets/agents/astra.webp' },
    { src: 'assets/agents/breach.webp' },
    { src: 'assets/agents/brimstone.webp' },
    { src: 'assets/agents/chamber.webp' },
    { src: 'assets/agents/clove.webp' },
    { src: 'assets/agents/cypher.webp' },
    { src: 'assets/agents/deadlock.webp' },
    { src: 'assets/agents/fade.webp' },
    { src: 'assets/agents/gekko.webp' },
    { src: 'assets/agents/harbor.webp' },
    { src: 'assets/agents/iso.webp' },
    { src: 'assets/agents/jett.webp' },
    { src: 'assets/agents/kayo.webp' },
    { src: 'assets/agents/killjoy.webp' },
    { src: 'assets/agents/neon.webp' },
    { src: 'assets/agents/omen.webp' },
    { src: 'assets/agents/phoenix.webp' },
    { src: 'assets/agents/raze.webp' },
    { src: 'assets/agents/reyna.webp' },
    { src: 'assets/agents/sage.webp' },
    { src: 'assets/agents/skye.webp' },
    { src: 'assets/agents/sova.webp' },
    { src: 'assets/agents/tejo.webp' },
    { src: 'assets/agents/viper.webp' },
    { src: 'assets/agents/vyse.webp' },
    { src: 'assets/agents/waylay.webp' },
    { src: 'assets/agents/yoru.webp' }
  ];
  buildSelectionRow(agentOptions, 'agent-button', value => {
    selectedAgent = value;
    if (modeToggle.checked) {
      refreshStats();
    }
  });

  const selectionDivider = document.createElement('hr');
  selectionDivider.classList.add('divider');
  selectionContainer.appendChild(selectionDivider);
}
const averageEl = document.getElementById('average');
const attributeKeys = ['physical', 'teamplay', 'judgement', 'alert', 'thinking', 'study'];
const attributeLabels = {
  physical: '„Éï„Ç£„Ç∏„Ç´„É´',
  teamplay: '„ÉÅ„Éº„É†„Éó„É¨„Ç§',
  judgement: 'Áä∂Ê≥ÅÂà§Êñ≠',
  alert: 'Ë≠¶ÊàíÂäõ',
  thinking: '‰øØÁû∞ÊÄùËÄÉ',
  study: 'Â∫ßÂ≠¶'
};

const rootStyles = getComputedStyle(document.documentElement);
const attributeColors = {
  physical: rootStyles.getPropertyValue('--color-physical').trim(),
  teamplay: rootStyles.getPropertyValue('--color-teamplay').trim(),
  judgement: rootStyles.getPropertyValue('--color-judgement').trim(),
  alert: rootStyles.getPropertyValue('--color-alert').trim(),
  thinking: rootStyles.getPropertyValue('--color-thinking').trim(),
  study: rootStyles.getPropertyValue('--color-study').trim()
};

const radarCanvas = document.getElementById('radar-chart');
const radarCtx = radarCanvas ? radarCanvas.getContext('2d') : null;
let currentChartValues = new Array(attributeKeys.length).fill(0);

// storage for summary notes
const summaryNotes = {
  good: '',
  bad: '',
  focus: ''
};

['good', 'bad', 'focus'].forEach(type => {
  const el = document.getElementById(`summary-${type}`);
  if (el) {
    el.addEventListener('input', e => {
      summaryNotes[type] = e.target.value;
    });
  }
});

// expose for later export
window.summaryNotes = summaryNotes;

function drawRoundedRect(ctx, x, y, width, height, radius) {
  ctx.beginPath();
  ctx.moveTo(x + radius, y);
  ctx.lineTo(x + width - radius, y);
  ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
  ctx.lineTo(x + width, y + height - radius);
  ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
  ctx.lineTo(x + radius, y + height);
  ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
  ctx.lineTo(x, y + radius);
  ctx.quadraticCurveTo(x, y, x + radius, y);
  ctx.closePath();
  ctx.fill();
}

function drawRadarChart(values) {
  if (!radarCtx) return;
  const ctx = radarCtx;
  const canvas = radarCanvas;
  const count = values.length;
  const maxVal = 100;
  const centerX = canvas.width / 2;
  const centerY = canvas.height / 2;
  // shrink drawing area to 80% so labels have more room
  const maxRadius = Math.min(centerX, centerY) - 10;
  const radius = maxRadius * 0.8;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const angleStep = (Math.PI * 2) / count;

  ctx.strokeStyle = '#ccc';
  ctx.fillStyle = '#000';
  for (let i = 0; i < count; i++) {
    const angle = -Math.PI / 2 + i * angleStep;
    const x = centerX + radius * Math.cos(angle);
    const y = centerY + radius * Math.sin(angle);
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.lineTo(x, y);
    ctx.stroke();

    const label = attributeLabels[attributeKeys[i]] || '';
    // leave extra space for the score beneath the label
    const labelRadius = radius + 12;
    const lx = centerX + labelRadius * Math.cos(angle);
    const ly = centerY + labelRadius * Math.sin(angle);
    if (Math.abs(Math.cos(angle)) < 0.1) {
      ctx.textAlign = 'center';
    } else {
      ctx.textAlign = Math.cos(angle) > 0 ? 'left' : 'right';
    }
    if (Math.abs(Math.sin(angle)) < 0.1) {
      ctx.textBaseline = 'middle';
    } else {
      ctx.textBaseline = Math.sin(angle) > 0 ? 'top' : 'bottom';
    }
    ctx.font = '12px sans-serif';
    const metrics = ctx.measureText(label);
    const textWidth = metrics.width;
    const textHeight = (metrics.actualBoundingBoxAscent || 0) + (metrics.actualBoundingBoxDescent || 0) || 12;
    const paddingX = 4;
    const paddingY = 2;
    const rectWidth = textWidth + paddingX * 2;
    const rectHeight = textHeight + paddingY * 2;
    let rectX = lx - paddingX;
    if (ctx.textAlign === 'center') {
      rectX -= textWidth / 2;
    } else if (ctx.textAlign === 'right') {
      rectX -= textWidth;
    }
    let rectY = ly - paddingY;
    if (ctx.textBaseline === 'middle') {
      rectY -= textHeight / 2;
    } else if (ctx.textBaseline === 'bottom') {
      rectY -= textHeight;
    }
    ctx.fillStyle = attributeColors[attributeKeys[i]];
    drawRoundedRect(ctx, rectX, rectY, rectWidth, rectHeight, 4);
    ctx.fillStyle = '#000';
    ctx.fillText(label, lx, ly);

    // Draw the score just inside the chart under the label
    const scoreRadius = radius - 4;
    const sx = centerX + scoreRadius * Math.cos(angle);
    const sy = centerY + scoreRadius * Math.sin(angle);
    ctx.font = '10px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(values[i].toFixed(1), sx, sy);
  }

  ctx.beginPath();
  for (let i = 0; i < count; i++) {
    const angle = -Math.PI / 2 + i * angleStep;
    const r = (values[i] / maxVal) * radius;
    const x = centerX + r * Math.cos(angle);
    const y = centerY + r * Math.sin(angle);
    if (i === 0) {
      ctx.moveTo(x, y);
    } else {
      ctx.lineTo(x, y);
    }
  }
  ctx.closePath();
  ctx.fillStyle = 'rgba(255, 99, 132, 0.3)';
  ctx.strokeStyle = '#ff6384';
  ctx.stroke();
  ctx.fill();
}

function resizeLayout() {
  if (!radarCanvas) return;
  // Base canvas height on viewport width, then widen to a 3:2 ratio
  const height = Math.min(Math.max(window.innerWidth * 0.22, 150), 220);
  const width = height * 1.5;
  radarCanvas.width = width;
  radarCanvas.height = height;
  const footer = document.getElementById('average-container');
  if (footer) {
    document.body.style.setProperty('--footer-height', `${footer.offsetHeight}px`);
  }
  drawRadarChart(currentChartValues);
}

window.addEventListener('resize', resizeLayout);
resizeLayout();

function normalizeAttributes(attrs) {
  if (Array.isArray(attrs)) {
    return attrs.slice();
  }
  if (!attrs) {
    return [];
  }
  return [attrs];
}

function normalizeNotes(note) {
  if (Array.isArray(note)) {
    return note.slice();
  }
  if (note === undefined || note === null || note === '') {
    return null;
  }
  return [note];
}

function addItem(item, sectionHeading = null, subsectionHeading = null) {
  if (!item || !item.id) return;
  const normalized = {
    id: item.id,
    text: item.text || '',
    attributes: normalizeAttributes(item.attributes || item.attribute),
    note: normalizeNotes(item.note),
    sectionHeading: sectionHeading ?? item.sectionHeading ?? null,
    subsectionHeading: subsectionHeading ?? item.subsectionHeading ?? null
  };

  kpiItems.push(normalized);
  const wrapper = document.createElement('div');
  wrapper.classList.add('kpi-item');
  wrapper.id = normalized.id;

  const textContainer = document.createElement('div');
  textContainer.classList.add('kpi-text');

  const label = document.createElement('label');
  label.textContent = normalized.text;
  textContainer.appendChild(label);

  if (normalized.note && normalized.note.length) {
    const noteEl = document.createElement('div');
    noteEl.classList.add('item-note');
    noteEl.innerHTML = normalized.note.join('<br>');
    textContainer.appendChild(noteEl);
  }

  // attribute tags
  const tagContainer = document.createElement('div');
  tagContainer.classList.add('item-tags');
  normalized.attributes.forEach(attr => {
    const tag = document.createElement('span');
    tag.classList.add('attribute-tag');
    tag.textContent = attributeLabels[attr] || attr;
    if (attributeColors[attr]) {
      tag.style.backgroundColor = attributeColors[attr];
    }
    tagContainer.appendChild(tag);
  });
  textContainer.appendChild(tagContainer);

  wrapper.appendChild(textContainer);

  const skipContainer = document.createElement('div');
  skipContainer.classList.add('skip-container');
  const skipCheckbox = document.createElement('input');
  skipCheckbox.type = 'checkbox';
  skipCheckbox.id = `${normalized.id}-skip`;
  const skipLabel = document.createElement('label');
  skipLabel.setAttribute('for', `${normalized.id}-skip`);
  skipLabel.textContent = 'Èô§Â§ñ';
  skipLabel.classList.add('skip-label');
  skipContainer.appendChild(skipCheckbox);
  skipContainer.appendChild(skipLabel);
  wrapper.appendChild(skipContainer);

  const isAdvancedMode = complexityToggle && complexityToggle.checked;
  wrapper.dataset.ratingMode = isAdvancedMode ? 'advanced' : 'simple';

  let ratingContainer;
  if (isAdvancedMode) {
    ratingContainer = document.createElement('div');
    ratingContainer.classList.add('star-rating');
    for (let i = 1; i <= 5; i++) {
      const star = document.createElement('span');
      star.classList.add('star');
      star.innerHTML = '‚òÖ';
      star.dataset.value = i;
      star.addEventListener('click', () => {
        const current = parseFloat(wrapper.dataset.rating || '0');
        const newRating = current === i ? 0 : i;
        setRating(wrapper, newRating);
        updateAverage();
      });
      ratingContainer.appendChild(star);
    }
  } else {
    ratingContainer = document.createElement('div');
    ratingContainer.classList.add('simple-rating');
    const simpleOptions = [
      { label: 'ÊÇ™„ÅÑ', emoji: 'üëé', score: 0 },
      { label: 'ÊôÆÈÄö', emoji: 'üòê', score: 50 },
      { label: 'ËâØ„ÅÑ', emoji: 'üëç', score: 100 }
    ];
    simpleOptions.forEach(option => {
      const button = document.createElement('button');
      button.type = 'button';
      button.classList.add('simple-rating-option');
      button.dataset.ratingValue = option.score / 20;
      button.innerHTML = `
        <span class="simple-rating-emoji">${option.emoji}</span>
        <span class="simple-rating-label">${option.label}</span>
      `;
      button.addEventListener('click', () => {
        const parsed = parseFloat(wrapper.dataset.rating);
        const current = Number.isNaN(parsed) ? null : parsed;
        const normalizedScore = option.score / 20;
        const isSame = current !== null && Math.abs(current - normalizedScore) < 0.001;
        const newRating = isSame ? null : normalizedScore;
        setRating(wrapper, newRating);
        updateAverage();
      });
      ratingContainer.appendChild(button);
    });
  }
  wrapper.appendChild(ratingContainer);

  const scoreWrapper = document.createElement('div');
  scoreWrapper.classList.add('score-container');

  const countDisplay = document.createElement('span');
  countDisplay.classList.add('data-count');
  scoreWrapper.appendChild(countDisplay);

  const scoreDisplay = document.createElement('span');
  scoreDisplay.classList.add('score-display');
  scoreWrapper.appendChild(scoreDisplay);

  wrapper.appendChild(scoreWrapper);
  const updateSkipAppearance = () => {
    wrapper.classList.toggle('kpi-item-skipped', skipCheckbox.checked);
  };

  skipCheckbox.addEventListener('change', () => {
    updateSkipAppearance();
    updateAverage();
  });

  updateSkipAppearance();
  container.appendChild(wrapper);
}

function clearKpiContainer() {
  if (!container) return;
  while (container.firstChild) {
    container.removeChild(container.firstChild);
  }
  kpiItems.length = 0;
}

function getActiveKpiData() {
  if (complexityToggle && complexityToggle.checked) {
    return advancedKpiData;
  }
  return simpleKpiData;
}

function buildDefaultKpiLayout() {
  if (!container) return;
  clearKpiContainer();
  const dataset = getActiveKpiData();
  dataset.forEach(section => {
    const sectionHeading = document.createElement('h2');
    sectionHeading.classList.add('section-heading');
    sectionHeading.textContent = section.heading;
    container.appendChild(sectionHeading);

    if (section.items) {
      section.items.forEach(item => addItem(item, section.heading));
    }
    if (section.subsections) {
      section.subsections.forEach(sub => {
        const subHeading = document.createElement('h3');
        subHeading.classList.add('subsection-heading');
        subHeading.textContent = sub.heading;
        container.appendChild(subHeading);
        if (sub.items) {
          sub.items.forEach(item => addItem(item, section.heading, sub.heading));
        }
      });
      const sectionDivider = document.createElement('hr');
      sectionDivider.classList.add('divider');
      container.appendChild(sectionDivider);
    } else {
      const sectionDivider = document.createElement('hr');
      sectionDivider.classList.add('divider');
      container.appendChild(sectionDivider);
    }
  });
}

function forEachKpiElement(data, callback) {
  if (!data) return;
  if (Array.isArray(data.kpiGroups)) {
    data.kpiGroups.forEach(section => {
      const sectionHeading = section && section.heading !== undefined ? section.heading : null;
      if (Array.isArray(section.items)) {
        section.items.forEach(item => callback(item, sectionHeading, null));
      }
      if (Array.isArray(section.subsections)) {
        section.subsections.forEach(sub => {
          const subHeading = sub && sub.heading !== undefined ? sub.heading : null;
          if (Array.isArray(sub.items)) {
            sub.items.forEach(item => callback(item, sectionHeading, subHeading));
          }
        });
      }
    });
  }
}

function buildStatsLayoutFromDatasets(datasets) {
  if (!container) return;
  const seenIds = new Set();
  const sections = [];
  const sectionMap = new Map();

  const getSection = heading => {
    const key = heading || '';
    if (!sectionMap.has(key)) {
      const section = { heading: heading, items: [], subsections: [] };
      sectionMap.set(key, section);
      sections.push(section);
    }
    return sectionMap.get(key);
  };

  const addToSection = (sectionHeading, subsectionHeading, item) => {
    if (!item || !item.id || seenIds.has(item.id)) return;
    seenIds.add(item.id);
    const section = getSection(sectionHeading);

    const normalizedItem = {
      id: item.id,
      text: item.text || '',
      attributes: item.attributes,
      attribute: item.attribute,
      note: item.note,
      sectionHeading: sectionHeading,
      subsectionHeading: subsectionHeading
    };

    if (subsectionHeading) {
      let subsection = section.subsections.find(sub => sub.heading === subsectionHeading);
      if (!subsection) {
        subsection = { heading: subsectionHeading, items: [] };
        section.subsections.push(subsection);
      }
      subsection.items.push(normalizedItem);
    } else {
      section.items.push(normalizedItem);
    }
  };

  datasets.forEach(data => {
    forEachKpiElement(data, (item, sectionHeading, subsectionHeading) => {
      addToSection(sectionHeading, subsectionHeading, item);
    });
  });

  clearKpiContainer();
  sections.forEach(section => {
    if (section.heading) {
      const sectionHeadingEl = document.createElement('h2');
      sectionHeadingEl.classList.add('section-heading');
      sectionHeadingEl.textContent = section.heading;
      container.appendChild(sectionHeadingEl);
    }

    if (section.items.length) {
      section.items.forEach(item => addItem(item, section.heading));
    }

    section.subsections.forEach(sub => {
      const subHeadingEl = document.createElement('h3');
      subHeadingEl.classList.add('subsection-heading');
      subHeadingEl.textContent = sub.heading;
      container.appendChild(subHeadingEl);
      sub.items.forEach(item => addItem(item, section.heading, sub.heading));
    });

    const divider = document.createElement('hr');
    divider.classList.add('divider');
    container.appendChild(divider);
  });
  applyMode();
}

  function updateAverage() {
    let total = 0;
    let count = 0;
    const attrTotals = {};
    const attrCounts = {};
    attributeKeys.forEach(key => {
      attrTotals[key] = 0;
      attrCounts[key] = 0;
    });

    kpiItems.forEach(item => {
      const skipCheckbox = document.getElementById(`${item.id}-skip`);
      if (skipCheckbox && skipCheckbox.checked) return;
      const wrapper = document.getElementById(item.id);
      if (!wrapper) return;
      const parsed = parseFloat(wrapper.dataset.rating);
      const rating = Number.isNaN(parsed) ? 0 : parsed;
      const score = rating * 20;
      total += score;
      count++;
      item.attributes.forEach(attr => {
        if (attrTotals[attr] === undefined) {
          attrTotals[attr] = 0;
          attrCounts[attr] = 0;
        }
        attrTotals[attr] += score;
        attrCounts[attr] += 1;
      });
    });

    const average = count ? total / count : 0;
    averageEl.textContent = average.toFixed(1);
    attributeKeys.forEach(key => {
      const avg = attrCounts[key] ? (attrTotals[key] / attrCounts[key]) : 0;
      const span = document.getElementById(`avg-${key}`);
      if (span) span.textContent = avg.toFixed(1);
    });
    const chartValues = attributeKeys.map(key => attrCounts[key] ? (attrTotals[key] / attrCounts[key]) : 0);
    currentChartValues = chartValues;
    drawRadarChart(chartValues);
    const footer = document.getElementById('average-container');
    if (footer) {
      document.body.style.setProperty('--footer-height', `${footer.offsetHeight}px`);
    }
  }

  function resetScores() {
    averageEl.textContent = '0.0';
    attributeKeys.forEach(key => {
      const span = document.getElementById(`avg-${key}`);
      if (span) span.textContent = '0.0';
    });
    const zeros = new Array(attributeKeys.length).fill(0);
    currentChartValues = zeros;
    drawRadarChart(zeros);
  }

  function updateStats(dataArray) {
    const attrTotals = {};
    const attrCounts = {};
    attributeKeys.forEach(key => {
      attrTotals[key] = 0;
      attrCounts[key] = 0;
    });
    const kpiTotals = {};
    const kpiCounts = {};
    kpiItems.forEach(item => {
      kpiTotals[item.id] = 0;
      kpiCounts[item.id] = 0;
    });
    let total = 0;
    let count = 0;
    dataArray.forEach(data => {
      forEachKpiElement(data, el => {
        if (el.skip) return;
        const score = typeof el.score === 'number' ? el.score : 0;
        if (kpiTotals[el.id] === undefined) {
          kpiTotals[el.id] = 0;
          kpiCounts[el.id] = 0;
        }
        kpiTotals[el.id] += score;
        kpiCounts[el.id] += 1;
        total += score;
        count++;
        if (Array.isArray(el.attributes)) {
          el.attributes.forEach(attr => {
            if (attrTotals[attr] === undefined) {
              attrTotals[attr] = 0;
              attrCounts[attr] = 0;
            }
            attrTotals[attr] += score;
            attrCounts[attr] += 1;
          });
        }
      });
    });
    kpiItems.forEach(item => {
      const wrapper = document.getElementById(item.id);
      if (!wrapper) return;
      const scoreContainer = wrapper.querySelector('.score-container');
      const scoreEl = wrapper.querySelector('.score-display');
      const countEl = wrapper.querySelector('.data-count');
      if (!scoreContainer || !scoreEl || !countEl) return;
      if (kpiCounts[item.id]) {
        countEl.textContent = `Ë©≤ÂΩì ${kpiCounts[item.id]} ‰ª∂`;
        const avg = (kpiTotals[item.id] / kpiCounts[item.id]).toFixed(1);
        scoreEl.innerHTML = `Âπ≥Âùá„Çπ„Ç≥„Ç¢ <span class="score-number">${avg}</span>`;
      } else {
        countEl.textContent = 'Ë©≤ÂΩì 0 ‰ª∂';
        scoreEl.innerHTML = 'Âπ≥Âùá„Çπ„Ç≥„Ç¢ <span class="score-number">N/A</span>';
      }
      scoreContainer.style.display = 'flex';
    });
    const average = count ? total / count : 0;
    averageEl.textContent = average.toFixed(1);
    attributeKeys.forEach(key => {
      const avg = attrCounts[key] ? (attrTotals[key] / attrCounts[key]) : 0;
      const span = document.getElementById(`avg-${key}`);
      if (span) span.textContent = avg.toFixed(1);
    });
    const chartValues = attributeKeys.map(key => attrCounts[key] ? (attrTotals[key] / attrCounts[key]) : 0);
    currentChartValues = chartValues;
    drawRadarChart(chartValues);
    const footer = document.getElementById('average-container');
    if (footer) {
      document.body.style.setProperty('--footer-height', `${footer.offsetHeight}px`);
    }
  }

  function refreshStats() {
    if (!modeToggle.checked) return;
    const filtered = loadedDatasets.filter(data => {
      if (selectedMap && data.map !== selectedMap) return false;
      if (selectedAgent && data.agent !== selectedAgent) return false;
      return true;
    });
    updateStats(filtered);
  }

  function loadJsonData(dataArray) {
    loadedDatasets = [];
    const incoming = Array.isArray(dataArray) ? dataArray : [dataArray];
    loadedDatasets.push(...incoming);
    if (modeToggle && modeToggle.checked) {
      buildStatsLayoutFromDatasets(loadedDatasets);
    }
    refreshStats();
  }

function setRating(wrapper, rating) {
  const numericValue = typeof rating === 'number' ? rating : parseFloat(rating);
  const hasNumericValue = !Number.isNaN(numericValue);

  if (!hasNumericValue) {
    delete wrapper.dataset.rating;
  } else {
    wrapper.dataset.rating = numericValue;
  }
  const mode = wrapper.dataset.ratingMode || 'advanced';
  if (mode === 'advanced') {
    const numeric = hasNumericValue ? numericValue : 0;
    const stars = wrapper.querySelectorAll('.star');
    stars.forEach((star, idx) => {
      star.classList.toggle('selected', idx < numeric);
    });
  } else {
    const numeric = hasNumericValue ? numericValue : null;
    const options = wrapper.querySelectorAll('.simple-rating-option');
    options.forEach(option => {
      const value = parseFloat(option.dataset.ratingValue || '0');
      const isSelected = numeric !== null && Math.abs(value - numeric) < 0.001;
      option.classList.toggle('selected', isSelected);
    });
  }
}

const csvInput = document.getElementById('csvFile');
if (csvInput) {
  csvInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(evt) {
      const text = evt.target.result.trim();
      const lines = text.split(/\r?\n/).slice(1); // skip header
      lines.forEach(line => {
        const [id, score] = line.split(',');
        const wrapper = document.getElementById(id);
        if (wrapper) {
          const rating = parseInt(score, 10) / 20;
          setRating(wrapper, rating);
        }
      });
      updateAverage();
    };
    reader.readAsText(file);
  });
}


function readJsonFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = evt => {
      try {
        resolve(JSON.parse(evt.target.result));
      } catch (err) {
        reject(err);
      }
    };
    reader.onerror = reject;
    reader.readAsText(file);
  });
}

async function collectJsonFromEntry(entry) {
  if (entry.isFile) {
    const file = await new Promise((resolve, reject) => entry.file(resolve, reject));
    if (file.name.endsWith('.json')) {
      return [await readJsonFile(file)];
    }
    return [];
  } else if (entry.isDirectory) {
    const dirReader = entry.createReader();
    const entries = await new Promise((resolve, reject) => dirReader.readEntries(resolve, reject));
    const results = [];
    for (const ent of entries) {
      if (ent.isFile && ent.name.endsWith('.json')) {
        results.push(...await collectJsonFromEntry(ent));
      }
    }
    return results;
  }
  return [];
}

if (dropArea) {
  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, e => {
      e.preventDefault();
      dropArea.classList.add('dragover');
    });
  });
  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, e => {
      e.preventDefault();
      dropArea.classList.remove('dragover');
    });
  });
  dropArea.addEventListener('drop', async e => {
    e.preventDefault();
    dropArea.classList.remove('dragover');
    const items = e.dataTransfer.items;
    const promises = [];
    if (items && items.length) {
      for (const item of items) {
        const entry = item.webkitGetAsEntry ? item.webkitGetAsEntry() : null;
        if (entry) {
          promises.push(collectJsonFromEntry(entry));
        }
      }
    } else {
      const files = e.dataTransfer.files;
      for (const file of files) {
        if (file.name.endsWith('.json')) {
          promises.push(readJsonFile(file).then(data => [data]));
        }
      }
    }
    try {
      const results = await Promise.all(promises);
      const datasets = results.flat();
      if (datasets.length) {
        loadJsonData(datasets);
      }
    } catch (err) {
      console.error(err);
    }
  });
}

document.getElementById('export-btn').addEventListener('click', () => {
  const groupOrder = [];
  const groupMap = new Map();

  const getGroup = heading => {
    const key = heading || '';
    if (!groupMap.has(key)) {
      const group = { heading: heading || null, items: [], subsections: [] };
      groupMap.set(key, group);
      groupOrder.push(group);
    }
    return groupMap.get(key);
  };

  const buildElement = item => {
    const skip = document.getElementById(`${item.id}-skip`).checked;
    const wrapper = document.getElementById(item.id);
    const rating = parseFloat(wrapper.dataset.rating || '0');
    const element = {
      id: item.id,
      text: item.text,
      attributes: item.attributes,
      skip: skip,
      score: rating * 20
    };
    if (item.note && item.note.length) {
      element.note = item.note.slice();
    }
    return element;
  };

  kpiItems.forEach(item => {
    const group = getGroup(item.sectionHeading);
    const element = buildElement(item);
    if (item.subsectionHeading) {
      let subsection = group.subsections.find(sub => sub.heading === item.subsectionHeading);
      if (!subsection) {
        subsection = { heading: item.subsectionHeading, items: [] };
        group.subsections.push(subsection);
      }
      subsection.items.push(element);
    } else {
      group.items.push(element);
    }
  });

  const textnotes = {
    wasgood: summaryNotes.good,
    wasbad: summaryNotes.bad,
    important: summaryNotes.focus
  };

  const exportData = {
    map: selectedMap,
    agent: selectedAgent,
    kpiGroups: groupOrder,
    textnotes
  };

  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const mapName = selectedMap ? selectedMap.toLowerCase() : 'unknown';
  const agentName = selectedAgent ? selectedAgent.toLowerCase() : 'unknown';
  const complexityName = complexityToggle && complexityToggle.checked ? 'advanced' : 'simple';
  a.download = `valoinsight_${complexityName}_${mapName}_${agentName}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

const modeToggle = document.getElementById('mode-toggle');
const statsPlaceholderValue = 0.0;

if (complexityToggle) {
  complexityToggle.addEventListener('change', () => {
    if (!modeToggle || !modeToggle.checked) {
      buildDefaultKpiLayout();
      applyMode();
    }
  });
}

function applyMode() {
  const isStatsMode = modeToggle && modeToggle.checked;
  const kpiContainer = document.getElementById('kpi-container');
  const summaryContainer = document.getElementById('summary-container');
  const exportBtn = document.getElementById('export-btn');

  if (kpiContainer) kpiContainer.style.display = '';
  if (summaryContainer) {
    summaryContainer.style.display = isStatsMode ? 'none' : '';
  }
  if (dropArea) {
    dropArea.style.display = isStatsMode ? '' : 'none';
  }
  if (exportBtn) {
    exportBtn.disabled = isStatsMode;
    exportBtn.style.display = isStatsMode ? 'none' : '';
  }

  if (complexityToggle) {
    complexityToggle.disabled = isStatsMode;
  }

  kpiItems.forEach(item => {
    const skipCheckbox = document.getElementById(`${item.id}-skip`);
    const wrapper = document.getElementById(item.id);
    if (!wrapper) return;
    const skipContainer = wrapper.querySelector('.skip-container');
    const ratingContainer = wrapper.querySelector('.star-rating, .simple-rating');
    const scoreContainer = wrapper.querySelector('.score-container');
    const scoreEl = wrapper.querySelector('.score-display');
    const countEl = wrapper.querySelector('.data-count');

    if (skipCheckbox) {
      skipCheckbox.disabled = isStatsMode;
    }

    if (skipContainer) {
      skipContainer.style.display = isStatsMode ? 'none' : '';
    }
    if (ratingContainer) {
      ratingContainer.style.display = isStatsMode ? 'none' : '';
    }
    if (scoreContainer) {
      scoreContainer.style.display = 'flex';
      if (!isStatsMode) {
        scoreContainer.style.display = 'none';
      }
    }
    if (isStatsMode && scoreEl && countEl) {
      scoreEl.innerHTML = `Âπ≥Âùá„Çπ„Ç≥„Ç¢ <span class="score-number">${statsPlaceholderValue}</span>`;
      countEl.textContent = 'Ë©≤ÂΩì 0 ‰ª∂';
    }
  });

  if (isStatsMode) {
    resetScores();
  } else {
    updateAverage();
  }
}

modeToggle.addEventListener('change', () => {
  if (modeToggle.checked) {
    loadedDatasets = [];
    clearKpiContainer();
  } else {
    buildDefaultKpiLayout();
  }
  applyMode();
});

buildDefaultKpiLayout();
applyMode();
